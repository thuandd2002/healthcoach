<?php
/* * IPN URL: Ghi nhận kết quả thanh toán từ VNPAY * Các bước thực hiện: * Kiểm tra checksum  * Tìm giao dịch trong database * Kiểm tra tình trạng của giao dịch trước khi cập nhật * Cập nhật kết quả vào Database * Trả kết quả ghi nhận lại cho VNPAY */
defined('_VALID_NVB') or die('Direct Access to this location is not allowed.');
error_reporting(E_ERROR);$vnp_TmnCode = "KATA0001"; //Mã website tại VNPAY //$vnp_HashSecret = "MAXRPVLWAVFARZYLCQGSHMTURANWURMU";  TEST$vnp_HashSecret = "LCURFKGFEREDRJYVEXKGSKREOLRSLYDA"; $inputData = array();$returnData = array();$data = $_REQUEST;foreach ($data as $key => $value) {    if (substr($key, 0, 4) == "vnp_") {        $inputData[$key] = $value;    }}$vnp_SecureHash = $inputData['vnp_SecureHash'];unset($inputData['vnp_SecureHashType']);unset($inputData['vnp_SecureHash']);ksort($inputData);$i = 0;$hashData = "";foreach ($inputData as $key => $value) {    if ($i == 1) {        $hashData = $hashData . '&' . $key . "=" . $value;    } else {        $hashData = $hashData . $key . "=" . $value;        $i = 1;    }}$vnpTranId = $inputData['vnp_TransactionNo']; //Mã giao dịch tại VNPAY$vnp_BankCode = $inputData['vnp_BankCode']; //Ngân hàng thanh toán//$secureHash = md5($vnp_HashSecret . $hashData);$secureHash = hash('sha256',$vnp_HashSecret . $hashData);$Status = 0;$orderId = $inputData['vnp_TxnRef'];try {    //Check Orderid        //Kiểm tra checksum của dữ liệu    if ($secureHash == $vnp_SecureHash) {        //Lấy thông tin đơn hàng lưu trong Database và kiểm tra trạng thái của đơn hàng, mã đơn hàng là: $orderId                    //Việc kiểm tra trạng thái của đơn hàng giúp hệ thống không xử lý trùng lặp, xử lý nhiều lần một giao dịch        //Giả sử: $order = mysqli_fetch_assoc($result);   				$order = NULL;				$orderId = intval($orderId);				$sql = "SELECT * FROM orders WHERE id_order = $orderId ";				$db = $DB->query($sql);		$order = mysql_fetch_array($db);                if ($order != NULL) {            if ($order["pay_status"] != NULL && $order["pay_status"] == 0) {                if ($inputData['vnp_ResponseCode'] == '00') {                    $pay_status = 1;					$transStatus = "GD Thanh cong";					                } else {                    $pay_status = 2;					$transStatus = "GD Khong thanh cong";                }                //Cài đặt Code cập nhật kết quả thanh toán, tình trạng đơn hàng vào DB                //                				$vnp_OrderInfo = clean_value($inputData['vnp_OrderInfo']);				$vnp_ResponseCode = clean_value($inputData['vnp_ResponseCode']);				$vnp_PayDate = clean_value($inputData['vnp_PayDate']);								$data = array();				$data['last_update'] = time() + $CONFIG['time_offset'];				$data['transStatus'] = clean_value($transStatus);				$data['OrderInfo'] = clean_value($vnp_OrderInfo);				$data['TransactionNo'] = clean_value($vnpTranId); //00 is success				$data['ResponseCode'] = clean_value($vnp_ResponseCode);				$data['BankCode'] = clean_value($vnp_BankCode);				$data['PayDate'] = clean_value($vnp_PayDate);				$data['pay_status'] = 2;	//1: Da cap nhat ket qua tra ve binh thuong, 2: cap nhat qua IPN				//var_dump($data);				$DBi->updateTableRow("orders", $data, "id_order", $orderId);								                //                //Trả kết quả về cho VNPAY: Website TMĐT ghi nhận yêu cầu thành công                                $returnData['RspCode'] = '00';                $returnData['Message'] = 'Confirm Success';            } else {                $returnData['RspCode'] = '02';                $returnData['Message'] = 'Order already confirmed';            }        } else {            $returnData['RspCode'] = '01';            $returnData['Message'] = 'Order not found';        }    } else {        $returnData['RspCode'] = '97';        $returnData['Message'] = 'Chu ky khong hop le';    }} catch (Exception $e) {    $returnData['RspCode'] = '99';    $returnData['Message'] = 'Unknow error';}//Trả lại VNPAY theo định dạng JSONecho json_encode($returnData);
?>